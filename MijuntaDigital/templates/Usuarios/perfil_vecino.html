{% extends 'base.html' %}
{% load static %}
{% block title %}Perfil de {{ perfil.nombre }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="card shadow p-4">
    <div class="row">
      <div class="col-md-3 text-center">

        <!-- Imagen de perfil -->
        {% if perfil.foto %}
          <img id="preview_foto" src="{{ perfil.foto.url }}" class="rounded-circle img-fluid mb-3 shadow-sm" width="130" height="130" style="object-fit: cover;">
        {% else %}
          <img id="preview_foto" src="{% static 'img/user-placeholder.png' %}" class="rounded-circle img-fluid mb-3 shadow-sm" width="130" height="130">
        {% endif %}

        <!-- Subir nueva foto -->
        {% if usuario_sesion.id_vecino == perfil.id_vecino %}
        <form method="post" enctype="multipart/form-data" class="mt-2">
          {% csrf_token %}
          <!-- Input oculto -->
          <input type="file" name="foto" id="id_foto" accept="image/*" style="display:none;" onchange="previewAndSubmit(this)">
          
          <!-- BotÃ³n visual -->
          <label for="id_foto" class="btn btn-sm btn-primary rounded-pill px-3 shadow-sm">
            <i class="bi bi-camera"></i> Cambiar foto
          </label>
        </form>
        {% endif %}

        <h4 class="mt-3 text-capitalize">{{ perfil.nombre }}</h4>
        <span class="badge bg-primary text-capitalize">{{ perfil.id_rol.nombre }}</span>
        <p class="text-muted mb-0">{{ perfil.estado }}</p>

        <!-- Cambio de rol (solo para el Presidente) -->
        {% if usuario_sesion.id_rol.nombre == "presidente" %}
        <form method="post" class="mt-3">
          {% csrf_token %}
          <select name="rol_id" class="form-select my-2">
            {% for rol in roles %}
              <option value="{{ rol.id_rol }}" {% if rol.id_rol == perfil.id_rol.id_rol %}selected{% endif %}>
                {{ rol.nombre }}
              </option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill">Actualizar Rol</button>
        </form>
        {% endif %}
      </div>

      <div class="col-md-9">
        <h5 class="mb-3">Datos Personales</h5>
        <ul class="list-group mb-3">
          <li class="list-group-item"><strong>RUN:</strong> {{ perfil.run }}</li>
          <li class="list-group-item"><strong>DirecciÃ³n:</strong> {{ perfil.direccion }}</li>
          <li class="list-group-item"><strong>Correo:</strong> {{ perfil.correo }}</li>
          <li class="list-group-item"><strong>TelÃ©fono:</strong> {{ perfil.telefono }}</li>
          <li class="list-group-item"><strong>Fecha de registro:</strong> {{ perfil.fecha_registro|date:"d/m/Y" }}</li>
        </ul>

        <h5>Actividad Reciente</h5>
        <ul class="list-group">
          {% for c in certificados %}
            <li class="list-group-item">ðŸ“œ Certificado {{ c.tipo }} - {{ c.fecha_emision|date:"d/m/Y H:i" }}</li>
          {% empty %}
            <li class="list-group-item text-muted">No tiene certificados recientes.</li>
          {% endfor %}
          {% for s in solicitudes %}
            <li class="list-group-item">ðŸ“¨ Solicitud {{ s.tipo }} - {{ s.estado }}</li>
          {% endfor %}
          {% for r in reservas %}
            <li class="list-group-item">ðŸ“… Reserva en {{ r.espacio }} - {{ r.estado }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Script para previsualizaciÃ³n -->
<script>
function previewAndSubmit(input) {
  const [file] = input.files;
  if (file) {
    const preview = document.getElementById('preview_foto');
    preview.src = URL.createObjectURL(file);
    setTimeout(() => input.form.submit(), 400);
  }
}
</script>
{% endblock %}
