{% extends 'base.html' %}
{% load static %}
{% block title %}Perfil de {{ perfil.nombre }}{% endblock %}

{% block content %}

{% if messages %}
<div class="container mt-4 d-flex justify-content-center">
  <div class="col-md-8">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm text-center position-relative"
      role="alert">
      <i class="fa-solid fa-circle-info me-2"></i> {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      <div class="alert-progress"></div>
    </div>
    {% endfor %}
  </div>
</div>
<script src="{% static 'js/mensaje.js' %}"></script>
{% endif %}

<div class="container my-4">

  <!-- CARD PRINCIPAL -->
  <div class="card shadow p-4" style="background-color: var(--color-bg-secondary); border: 0cap var(--color-border);">

    <div class="row">
      <div class="col-md-3 text-center">

        {% if perfil.foto %}
          <img id="preview_foto" src="{{ perfil.foto.url }}" class="rounded-circle img-fluid mb-3 shadow-sm"
               width="140" height="140" style="object-fit: cover;">
        {% else %}
          <img id="preview_foto" src="{% static 'img/user-placeholder.png' %}" class="rounded-circle img-fluid mb-3 shadow-sm"
               width="140" height="140">
        {% endif %}

        {% if usuario_sesion.id_vecino == perfil.id_vecino %}
        <form method="post" enctype="multipart/form-data" class="mt-2">
          {% csrf_token %}
          <input type="file" name="foto" id="id_foto" accept="image/*" style="display:none;" onchange="previewAndSubmit(this)">
          <label for="id_foto" class="btn btn-sm btn-primary rounded-pill px-3 shadow-sm">
            <i class="bi bi-camera"></i> Cambiar foto
          </label>
        </form>
        {% endif %}

        <h4 class="mt-3 text-capitalize" style="color: white;">{{ perfil.nombre }}</h4>
        <span class="badge bg-primary text-capitalize">{{ perfil.id_rol.nombre }}</span>
        <p class="text-muted mb-0">{{ perfil.estado }}</p>

      </div>

      <div class="col-md-9">
        <h5 class="mb-3" style="color: var(--color-primary);">Datos Personales</h5>

        <ul class="list-group mb-3">
          <li class="list-group-item bg-transparent border-secondary text-white"><strong>RUN:</strong> {{ perfil.run }}</li>
          <li class="list-group-item bg-transparent border-secondary text-white"><strong>Dirección:</strong> {{ perfil.direccion }}</li>
          <li class="list-group-item bg-transparent border-secondary text-white"><strong>Correo:</strong> {{ perfil.correo }}</li>
          <li class="list-group-item bg-transparent border-secondary text-white"><strong>Teléfono:</strong> {{ perfil.telefono }}</li>
          <li class="list-group-item bg-transparent border-secondary text-white">
            <strong>Fecha registro:</strong> {{ perfil.fecha_registro|date:"d/m/Y" }}
          </li>
        </ul>

        <h5 class="mb-2" style="color: var(--color-primary);">Actividad Reciente</h5>

        <ul class="list-group">
          {% for c in certificados %}
            <li class="list-group-item bg-transparent border-secondary text-white">
              Certificado {{ c.tipo }} — {{ c.fecha_emision|date:"d/m/Y H:i" }}
            </li>
          {% empty %}
            <li class="list-group-item bg-transparent border-secondary text-white">No tiene certificados recientes.</li>
          {% endfor %}

          {% for s in solicitudes %}
            <li class="list-group-item bg-transparent border-secondary text-white">
              Solicitud {{ s.tipo }} — {{ s.estado }}
            </li>
          {% endfor %}

          {% for r in reservas %}
            <li class="list-group-item bg-transparent border-secondary text-white">
              Reserva en {{ r.espacio }} — {{ r.estado }}
            </li>
          {% endfor %}
        </ul>

      </div>
    </div>
  </div>


  <!-- ============================= -->
  <!--     NUEVO BLOQUE DE OPCIONES -->
  <!-- ============================= -->
  <div class="card shadow p-4 mt-4"
       style="background-color: var(--color-bg-secondary); border: 1px solid var(--color-border);">

    <h5 class="mb-3" style="color: var(--color-primary);">
      <i class="bi bi-gear-fill"></i> Opciones de tu Cuenta
    </h5>

    <ul class="list-group">

      <li class="list-group-item bg-transparent border-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-person-lines-fill me-2"></i> Editar información personal</span>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditarPerfil">Editar</button>
      </li>

      <li class="list-group-item bg-transparent border-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-envelope-at-fill me-2"></i> Actualizar contacto</span>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditarContacto">Actualizar</button>
      </li>

      <li class="list-group-item bg-transparent border-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-shield-lock-fill me-2"></i> Cambiar contraseña</span>
        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalCambiarPass">Cambiar</button>
      </li>

    </ul>

  </div>


  <!-- ============================= -->
  <!--     TOTAL RECAUDADO -->
  <!-- ============================= -->
  <div class="d-flex justify-content-center mt-4">
    <div class="card shadow p-4"
         style="width: 380px; background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); text-align:center;">

      <h4 class="mb-3" style="color: var(--color-primary);"><i class="bi bi-cash-coin"></i> Total Recaudado</h4>

      <div class="p-3 rounded"
           style="background-color: var(--color-bg-primary); border: 1px solid var(--color-border);">

        <small class="text-white">Gracias al apoyo de todos los vecinos hemos recaudado:</small>
        <h2 class="fw-bold text-success mb-0">${{ total_recaudado|floatformat:0 }}</h2>

      </div>

    </div>
  </div>

</div>


<!-- ============================= -->
<!--       MODAL EDITAR PERFIL     -->
<!-- ============================= -->
<div class="modal fade" id="modalEditarPerfil" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'editar_perfil' perfil.id_vecino %}">
      {% csrf_token %}
      <div class="modal-content" style="background: #1e1e1e; color:white;">
        <div class="modal-header">
          <h5 class="modal-title">Editar información personal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <label>Nombre</label>
          <input type="text" name="nombre" class="form-control" value="{{ perfil.nombre }}" required>

          <label class="mt-2">Dirección</label>
          <input type="text" name="direccion" class="form-control" value="{{ perfil.direccion }}" required>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ============================= -->
<!--     MODAL EDITAR CONTACTO     -->
<!-- ============================= -->
<div class="modal fade" id="modalEditarContacto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'editar_contacto' perfil.id_vecino %}">
      {% csrf_token %}
      <div class="modal-content" style="background: #1e1e1e; color:white;">
        <div class="modal-header">
          <h5 class="modal-title">Actualizar datos de contacto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <label>Correo electrónico</label>
          <input type="email" name="correo" class="form-control" value="{{ perfil.correo }}" required>

          <label class="mt-2">Teléfono</label>
          <input type="text" name="telefono" class="form-control" value="{{ perfil.telefono }}">

          <label class="mt-2">Dirección</label>
          <input type="text" name="direccion" class="form-control" value="{{ perfil.direccion }}">
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>


<!-- ============================= -->
<!--     MODAL CAMBIAR CONTRASEÑA  -->
<!-- ============================= -->
<div class="modal fade" id="modalCambiarPass" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'cambiar_contrasena_perfil' perfil.id_vecino %}">
      {% csrf_token %}
      <div class="modal-content" style="background: #1e1e1e; color:white;">
        <div class="modal-header">
          <h5 class="modal-title">Cambiar contraseña</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <label>Contraseña actual</label>
          <input type="password" name="actual" class="form-control" required>

          <label class="mt-2">Nueva contraseña</label>
          <input type="password" name="nueva" class="form-control" required>

          <label class="mt-2">Confirmar nueva contraseña</label>
          <input type="password" name="confirmar" class="form-control" required>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Actualizar</button>
        </div>

      </div>
    </form>
  </div>
</div>


<!-- PREVISUALIZAR FOTO -->
<script>
function previewAndSubmit(input) {
    const [file] = input.files;
    if (file) {
        document.getElementById('preview_foto').src = URL.createObjectURL(file);
        setTimeout(() => input.form.submit(), 400);
    }
}
</script>

{% endblock %}
